<?php
include("dbconnect.php");

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

function getRounds()
{
    $conn = getDBConnection();

    $sql = "SELECT ArcherInfo.FirstName, ArcherInfo.LastName, Category.CategoryID
            FROM ArcherInfo
            JOIN Category ON ArcherInfo.ArcherID = Category.ArcherID";
    $result = $conn->query($sql);

    if ($result->num_rows > 0) {
        echo "<form method='post' action='scores.php'>";
        getEquipment();
        echo "<label for='categoryId'>Archer Name</label>";
        echo "<select name='categoryId'>";

        while ($row = $result->fetch_assoc()) {
            $archerName = $row['FirstName'] . " " . $row['LastName'];
            echo "<option value='" . $row['CategoryID'] . "'>ID: " . $row['CategoryID'] . " " . $archerName . "</option>";
        }

        echo "</select>";
        echo "<input type='submit' name='selectCategoryId' value='Select'>";
        echo "</form>";
    } else {
        echo "No Archer Found";
    }

    $conn->close();
}

// Get Archer Equipment
function getEquipment()
{
    $conn = getDBConnection();

    $sql = "SELECT * FROM `EquipmentDescription`";
    $result = $conn->query($sql);

    if ($result->num_rows > 0) {
        echo "<label for='Equipment'>Equipment:</label>";
        echo "<select name='EquipmentDescription'>";

        while ($row = $result->fetch_assoc()) {
            echo "<option value='" . $row['EquipmentDescription'] . "'>" . $row['EquipmentDescription'] . "</option>";
        }

        echo "</select>";
    }

    $conn->close();
}

// Get Archer full name
function getArcherFullName($categoryID)
{
    $conn = getDBConnection();

    $sql = "SELECT ArcherInfo.FirstName, ArcherInfo.LastName
            FROM ArcherInfo
            JOIN Category ON ArcherInfo.ArcherID = Category.ArcherID
            WHERE Category.CategoryID = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $categoryID);
    $stmt->execute();
    $stmt->bind_result($firstName, $lastName);

    $fullName = null;
    if ($stmt->fetch()) {
        $fullName = $firstName . " " . $lastName;
    }

    $stmt->close();
    $conn->close();

    return $fullName;
}

function getDistanceForm($categoryId, $equipment)
{
    $roundName = getRoundName($categoryId);
    $ranges = getRanges($categoryId);

    echo "<h2>" . $roundName . "</h2>";
    echo "<h2>" . getArcherFullName($categoryId) . ", " . $equipment . "</h2>";
    echo "<form method='post'>";
    echo "<label for='distance'>Select Distance:</label>";
    echo "<select name='distance'>";

    foreach ($ranges as $distance => $data) {
        $targetFaceSize = $data['FaceSize'];
        $distanceNFace = $distance . ' - Target Size: ' . $targetFaceSize;
        echo "<option value='" . $distanceNFace . "'>" . $distanceNFace . "</option>";
    }

    echo "</select>";
    echo "<input type='submit' name='selectDistance' value='Select Distance'>";
    echo "</form>";
}

function selectDistance()
{
    $selectedCategoryId = null;
    $selectedEquipment = null;

    if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['selectCategoryId'])) {
        $selectedCategoryId = $_POST['categoryId'];
        $selectedEquipment = $_POST['EquipmentDescription'];
        getDistanceForm($selectedCategoryId, $selectedEquipment);
        echo "<script>";
        echo "document.querySelector('form[action=\"scores.php\"]').style.display = 'none';";
        echo "</script>";
    }

    return [$selectedCategoryId, $selectedEquipment];
}

function getEnds($distance, $categoryId, $equipment)
{
    echo "<h2>" . getRoundName($categoryId) . "</h2>";
    echo "<h2>" . getArcherFullName($categoryId) . ", " . $equipment . "</h2>";
    echo "<h2>Selected Distance: " . $distance . "</h2>";

    $ranges = getRanges($categoryId);

    echo "<form method='post'>";
    echo "<label for='endNoList'>Select End No:</label>";
    echo "<select name='endNoList'>";

    if (isset($ranges[$distance]['EndNoList'])) {
        $endNumbers = $ranges[$distance]['EndNoList'];
        foreach ($endNumbers as $endNo) {
            echo "<option value='" . $endNo . "'>" . $endNo . "</option>";
        }
    }

    echo "</select>";
    echo "<input type='submit' name='selectEndNo' value='Select End No'>";
    echo "</form>";
}

function selectEndNo($categoryId, $equipment)
{
    if (isset($_POST['selectDistance'])) {
        $selectedDistanceFull = $_POST['distance'];
        $selectedDistance = str_replace(' - ', '', $selectedDistanceFull);

        $archerName = getArcherFullName($categoryId);

        echo "<h2>" . getRoundName($categoryId) . "</h2>";
        echo "<h2>" . $archerName . ", " . $equipment . "</h2>";
        echo "<h2>Selected Distance: " . $selectedDistanceFull . "</h2>";

        echo "<form method='post'>";
        echo "<label for='endNoList'>Select End No:</label>";
        echo "<select name='endNoList'>";
        echo "<option value='0'>End1</option>";
        echo "<option value='1'>End2</option>";
        echo "<option value='2'>End3</option>";
        echo "<option value='3'>End4</option>";
        echo "<option value='4'>End5</option>";
        echo "</select>";
        echo "<input type='hidden' name='categoryId' value='$categoryId'>"; // Add CategoryID as a hidden field
        echo "<input type='submit' name='selectEndNo' value='Select End No'>";

        // Add the hidden fields for selected values
        echo "<input type='hidden' name='selectedDistance' value='$selectedDistance'>";
        echo "<input type='hidden' name='selectedCategoryId' value='$categoryId'>";
        echo "<input type='hidden' name='selectedEquipment' value='$equipment'>";

        echo "</form>";

        if (isset($_POST['selectEndNo'])) {
            $selectedEndNo = $_POST['endNoList'];
            $selectedDistance = $_POST['selectedDistance'];
            $selectedCategoryId = $_POST['selectedCategoryId'];
            $selectedEquipment = $_POST['selectedEquipment'];

            echo "<h2>Record Scores for " . getArcherFullName($selectedCategoryId) . ", " . $selectedEquipment . ", " . $selectedDistance . ", " . $selectedEndNo . "</h2>";
            echo "<form method='post'>";
            echo "<input type='hidden' name='selectedDistance' value='$selectedDistance'>";
            echo "<input type='hidden' name='selectedCategoryId' value='$selectedCategoryId'>";
            echo "<input type='hidden' name='selectedEquipment' value='$selectedEquipment'>";
            echo "<input type='hidden' name='selectedEndNo' value='$selectedEndNo'>";
            for ($i = 1; $i <= 6; $i++) {
                echo "<label for='arrow$i'>Arrow $i:</label>";
                echo "<input type='number' id='arrow$i' name='arrow$i' min='0' max='10' required>";
            }
            echo "<input type='submit' name='submitScore' value='Submit Score'>";
            echo "</form>";
        }

        echo "<script>";
        echo "document.querySelector('form[action=\"scores.php\"]').style.display = 'none';";
        echo "</script>";
    }
}

function recordScore()
{
    if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['selectEndNo'])) {
        $selectedEndNo = $_POST['endNoList'];
        $selectedDistance = $_POST['selectedDistance'];
        $selectedCategoryId = $_POST['selectedCategoryId'];
        $selectedEquipment = $_POST['selectedEquipment'];
        echo "<h2>Record Scores for " . getArcherFullName($selectedCategoryId) . ", " . $selectedEquipment . ", " . $selectedDistance . ", " . $selectedEndNo . "</h2>";
        echo "<form method='post'>";
        echo "<input type='hidden' name='selectedDistance' value='$selectedDistance'>";
        echo "<input type='hidden' name='selectedCategoryId' value='$selectedCategoryId'>";
        echo "<input type='hidden' name='selectedEquipment' value='$selectedEquipment'>";
        echo "<input type='hidden' name='selectedEndNo' value='$selectedEndNo'>";
        for ($i = 1; $i <= 6; $i++) {
            echo "<label for='arrow$i'>Arrow $i:</label>";
            echo "<input type='number' id='arrow$i' name='arrow$i' min='0' max='10' required>";
        }
        echo "<input type='submit' name='submitScore' value='Submit Score'>";
        echo "</form>";
    }
}

function saveScore()
{
    if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['submitScore'])) {
        $conn = getDBConnection();

        $selectedEndNo = $_POST['selectedEndNo'];
        $selectedDistance = $_POST['selectedDistance'];
        $selectedCategoryId = $_POST['selectedCategoryId'];
        $selectedEquipment = $_POST['selectedEquipment'];
        $arrow1 = $_POST['arrow1'];
        $arrow2 = $_POST['arrow2'];
        $arrow3 = $_POST['arrow3'];
        $arrow4 = $_POST['arrow4'];
        $arrow5 = $_POST['arrow5'];
        $arrow6 = $_POST['arrow6'];

        $sql = "INSERT INTO EndScores (EndNo, CategoryID, Equipment, Distance, Arrow1, Arrow2, Arrow3, Arrow4, Arrow5, Arrow6)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        $stmt = $conn->prepare($sql);

        if (!$stmt) {
            echo "Error: " . $conn->error; // Print the error message
        } else {
            $stmt->bind_param("iisiiiiiii", $selectedEndNo, $selectedCategoryId, $selectedEquipment, $selectedDistance, $arrow1, $arrow2, $arrow3, $arrow4, $arrow5, $arrow6);
            $stmt->execute();
            if ($stmt->error) {
                echo "Error: " . $stmt->error;
            } else {
                echo "<h2>Score Recorded Successfully!</h2>";
            }
            $stmt->close();
        }

        $conn->close();
    }
}

getRounds();

list($selectedCategoryId, $selectedEquipment) = selectDistance();

$ranges = getRanges($selectedCategoryId);

selectEndNo($selectedCategoryId, $selectedEquipment);

recordScore();

saveScore();

function getRoundName($categoryId)
{
    $conn = getDBConnection();

    $sql = "SELECT Category.RoundName
            FROM Category
            WHERE Category.CategoryID = $categoryId";

    $result = $conn->query($sql);

    if ($result && $result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $roundName = $row['RoundName'];
        return $roundName;
    }

    $conn->close();
    return null;
}

function getRoundData($roundName)
{
    $conn = getDBConnection();

    $sql = "SELECT * FROM Rounds WHERE RoundName = '$roundName'";
    $result = $conn->query($sql);

    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $roundName = $row['RoundName'];
        $arrows10m = $row['Arrows10m'];
        $arrows20m = $row['Arrows20m'];
        $arrows30m = $row['Arrows30m'];
        $arrows40m = $row['Arrows40m'];
        $arrows50m = $row['Arrows50m'];
        $arrows60m = $row['Arrows60m'];
        $arrows70m = $row['Arrows70m'];
        $arrows90m = $row['Arrows90m'];

        $conn->close();

        return [
            'roundName' => $roundName,
            'arrows10m' => $arrows10m,
            'arrows20m' => $arrows20m,
            'arrows30m' => $arrows30m,
            'arrows40m' => $arrows40m,
            'arrows50m' => $arrows50m,
            'arrows60m' => $arrows60m,
            'arrows70m' => $arrows70m,
            'arrows90m' => $arrows90m
        ];
    } else {
        $conn->close();
        return null;
    }
}

function getTargetFaceSize($arrow)
{
    $char = substr($arrow, 2);
    $conn = getDBConnection();
    $sql = "SELECT FaceDesc FROM TargetFaceSizeDescription WHERE Target = '$char'";
    $result = $conn->query($sql);

    if ($result && $result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $faceSize = $row['FaceDesc'];
        return $faceSize;
    }

    $conn->close();
    return null;
}

function getNoOfEnds($string)
{
    $integer = intval($string);
    $result = $integer / 6;
    return $result;
}

function splitArrows($x)
{
    $arrow = substr($x, 0, 2);
    return $arrow;
}

function endNoList($number)
{
    $ends = array();

    for ($i = 1; $i <= $number; $i++) {
        $ends[] = "End" . $i;
    }

    return $ends;
}

function getRanges($categoryId)
{
    $roundName = getRoundName($categoryId);

    if ($roundName) {
        $roundData = getRoundData($roundName);
        $ranges = array();

        for ($distance = 10; $distance <= 90; $distance += 10) {
            if ($distance === 80) {
                continue;
            }

            $attribute = $distance . "m";

            if ($roundData['arrows' . $attribute] != 0) {
                $arrows = splitArrows($roundData['arrows' . $attribute]);
                $faceSize = getTargetFaceSize($roundData['arrows' . $attribute]);
                $ends = getNoOfEnds($arrows);

                $ranges[$attribute] = array(
                    'Arrow' => $arrows,
                    'FaceSize' => $faceSize,
                    'NoOfEnds' => $ends,
                    'EndNoList' => endNoList($ends)
                );
            }
        }

        return $ranges;
    }
}

echo "<pre>";
print_r($ranges);
echo "</pre>";
?>
